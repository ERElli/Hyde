<body>
	<div id ="container">
  		<canvas id="background" width="558" height="372"  style="position: absolute; left: 0; top: 0; z-index: 0;"></canvas>
 		<canvas id="entityPreview" width="558" height="372" style="position: absolute; left: 0; top: 0; z-index: 2;"></canvas>
  		<canvas id="grid" width="558" height="372" style="position: absolute; left:0; top: 0; z-index: 3;"></canvas>
  		<canvas id="levelground" width="558" height="372"  style="position: absolute; left: 0; top: 0; z-index: 1;"></canvas>
 	</div>
</body>

<script type="text/javascript" src="Terrain.js"></script>
<script type="text/javascript" src="Map.js"></script>
<script type="text/javascript" src="GUI.js"></script>
	
<script>
var bg = document.getElementById("background");
var ep = document.getElementById("entityPreview");
var lg = document.getElementById("levelground");
var gr = document.getElementById("grid");

var ctx_bg = bg.getContext("2d");
var ctx_lg = lg.getContext("2d");
var ctx_ep = ep.getContext("2d");
var ctx_gr = gr.getContext("2d");

//This makes the preview of the entity transparent
ctx_ep.globalAlpha = 0.3;

//Initial values
var WIDTH = 558*2;
var HEIGHT = 372*2;
var TILE_WIDTH = 31;
var TILE_HEIGHT = 31;
var frameCount = 0;
var rectWIDTH = 31*2;
var rectHEIGHT = 31*2;
var buttonStartingX = TILE_WIDTH*2;
var mouseLeft = false;
var mouseRight = false;
var offsetX = 0;
var offsetY = 0;
var fps = 60;
var controls = {
	left: false,
	up: false,
	right: false,
	down: false,
};

//Defining the bounds 
var backgroundButtonBounds= {
	x:buttonStartingX+ 4*TILE_WIDTH,
	y:0,
	width:TILE_HEIGHT*2,
	heigth:TILE_HEIGHT*2,
};

//Creating images
var backgroundImage = new Image();
backgroundImage.src = "../../images/background.png";

var enemyButtonImage = new Image();
enemyButtonImage.src = "../../images/enemiesButton.png";

var musicButtonImage = new Image();
musicButtonImage.src = "../../images/musicButton.png";

var backgroundButtonImage = new Image();
backgroundButtonImage.src = "../../images/backgroundButton.png";

var checkPointButtonImage = new Image();
checkPointButtonImage.src = "../../images/checkPointButton.png";

var characterButtonImage = new Image();
characterButtonImage.src = "../../images/characterButton.png";

var terrainButtonImage = new Image();
terrainButtonImage.src = "../../images/terrainButton.png";

var weaponButtonImage = new Image();
weaponButtonImage.src = "../../images/weaponButton.png";

//Initializing the map
var map = Map(WIDTH,HEIGHT,TILE_WIDTH,TILE_HEIGHT);
map.setBackgroundImage(backgroundImage.src);

window.addEventListener("keydown",function(e){
	switch(e.keyCode){
		case 37:
			controls.left = true;
			e.preventDefault();
			break;
		case 38:
			controls.up = true;
			e.preventDefault();
			break;
		case 39:
			controls.right = true;
			e.preventDefault();
			break;
		case 40:
			controls.down = true;
			e.preventDefault();
			break;
	}
});

window.addEventListener("keyup",function(e){
	switch(e.keyCode){
		case 37:
			controls.left = false;
			break;
		case 38:
			controls.up = false;
			break;
		case 39:
			controls.right = false;
			break;
		case 40:
			controls.down = false;
			break;
	}
	e.preventDefault();
});

doPressedAction = function() {
	if(controls.left){
		ctx_lg.translate(-offsetX,-offsetY);
		(offsetX===0)? offsetX = 0 : (offsetX += TILE_WIDTH);
		ctx_lg.translate(offsetX,offsetY);
	}
	if(controls.right){
		ctx_lg.translate(-offsetX,-offsetY);
		(offsetX===(background.width-WIDTH))? (offsetX = background.width-WIDTH) : offsetX -= TILE_WIDTH;
		ctx_lg.translate(offsetX,offsetY);
	}
	if(controls.up){
		ctx_lg.translate(-offsetX,-offsetY);
		(offsetY===0)? offsetY = 0 : (offsetY += TILE_HEIGHT);
		ctx_lg.translate(offsetX,offsetY);
	}
	if(controls.down){
		ctx_lg.translate(-offsetX,-offsetY);
		(offsetY===(background.height-HEIGHT))? (offsetY = background.height-HEIGHT) : offsetY -= TILE_HEIGHT;
		ctx_lg.translate(offsetX,offsetY);
	}
	if(mouseLeft){
		putEntity();
	}
	if(mouseRight){
		deleteEntity();
	}
};

//Drawing a preview of the object to be placed on the level
//and snapping the top right corner of the preview to the grid lines
snapToGrid  = function(canvas,mouse){
	var pos = getMousePosition(canvas,mouse);
	var prev_x = pos.x - (pos.x % TILE_HEIGHT);
	var prev_y = pos.y - (pos.y % TILE_WIDTH);

	var previewImage = new Image();
	previewImage.src = "../../images/buildingTerrain3x6.png";

	ctx_ep.drawImage(previewImage,prev_x, prev_y, rectWIDTH, rectHEIGHT);
};

var pos;
var id;
var x;
var y;

document.onmousemove = function(mouse){
	pos = getMousePosition(bg,mouse);
	id = Math.random();
	x = pos.x - (pos.x % TILE_HEIGHT) - offsetX;
	y = pos.y - (pos.y % TILE_WIDTH) - offsetY;

	var mouseBelowUpperBound = pos.x<WIDTH && pos.y<HEIGHT;
	var mouseAboveLowerBound = pos.x>0 && pos.y>TILE_HEIGHT*2;

	if(mouseBelowUpperBound && mouseAboveLowerBound){
		ctx_ep.clearRect(0,0,WIDTH,HEIGHT);
		snapToGrid(ep,mouse);
	}
};

getMousePosition = function(canvas,mouse){
	var rect = canvas.getBoundingClientRect();
	return {
		x: mouse.clientX - rect.left,
		y: mouse.clientY - rect.top,
	};
};

document.onmousedown = function(mouse){
	if(mouse.which ===1){
		mouseLeft = true;
	}
	else{
		mouseRight = true;
	}

	pos = getMousePosition(bg,mouse);
	id = Math.random();
	x = pos.x - (pos.x % TILE_HEIGHT) - offsetX;
	y = pos.y - (pos.y % TILE_WIDTH) - offsetY;
};

putEntity = function() {
	var mouseBelowUpperBound = pos.x<levelground.width && pos.y<levelground.height;
	var mouseAboveLowerBound = pos.x>0 && pos.y>TILE_HEIGHT*2;

	if(mouseBelowUpperBound && mouseAboveLowerBound){
		if(((x+rectWIDTH) <= WIDTH) && ((y+rectHEIGHT) <= HEIGHT)){
			var terrain = Terrain(id,x,y,rectWIDTH,rectHEIGHT);
			map.placeEntity(terrain);
		}
		else{
			console.log("Can not place object there");
		}
	}
};

deleteEntity = function() {
	map.removeEntity(x,y);
};

document.onmouseup = function(mouse){
	if(mouse.which ===1){
		mouseLeft = false;
	}
	else{
		mouseRight = false;
	}
};

//Supressing context menu on right click
document.oncontextmenu = function(mouse){
	mouse.preventDefault();
};

//Checking if mouse is withing a specified area
function isInside(pos, rect){
	return pos.x > rect.x && pos.x < rect.x+rect.width && pos.y < rect.y+rect.heigth && pos.y > rect.y;
}

drawGrid = function(){
	ctx_gr.globalAlpha = 0.05;
	ctx_gr.lineWidth = 2;
	ctx_gr.strokeStyle = "#515151";

	//Drawing vertical lines
	for(x=TILE_WIDTH; x<=WIDTH*2; x+=TILE_WIDTH){
		ctx_gr.moveTo(x,TILE_HEIGHT*2);	//The first 2 rows of the canvas are used by buttons
		ctx_gr.lineTo(x,HEIGHT);
		ctx_gr.stroke();
	}

	//Drawing horizontal lines
	for(y=TILE_HEIGHT*2; y<=HEIGHT*2; y+=TILE_HEIGHT){
		ctx_gr.moveTo(0,y);
		ctx_gr.lineTo(WIDTH,y);
		ctx_gr.stroke();
	}

	ctx_gr.globalAlpha = 1;
};

document.addEventListener('click', function(evt){
	var mousePos = getMousePosition(bg, evt);
	if(isInside(mousePos, backgroundButtonBounds)){
		console.log('clicked inside background button');
	} else {
		// alert('clicked outside background button');
	}
	
}, false);

addButtonImages = function() {
	ctx_gr.drawImage(enemyButtonImage,buttonStartingX, 0);
	ctx_gr.drawImage(musicButtonImage, buttonStartingX+ 2*TILE_WIDTH, 0);
	ctx_gr.drawImage(backgroundButtonImage, buttonStartingX+ 4*TILE_WIDTH, 0);
	ctx_gr.drawImage(checkPointButtonImage, buttonStartingX+ 6*TILE_WIDTH, 0);
	ctx_gr.drawImage(characterButtonImage, buttonStartingX+ 8*TILE_WIDTH, 0);
	ctx_gr.drawImage(terrainButtonImage, buttonStartingX+ 10*TILE_WIDTH, 0);
	ctx_gr.drawImage(weaponButtonImage, buttonStartingX+ 12*TILE_WIDTH, 0);
};

update = function() {
	frameCount++;
	ctx_lg.clearRect(0,0,WIDTH,HEIGHT);
	ctx_bg.drawImage(backgroundImage, 0,0,backgroundImage.width,backgroundImage.height, offsetX,offsetY,WIDTH,HEIGHT);
	addButtonImages();
	Map.update();
	if(frameCount%4 === 0){
		doPressedAction();
	}
};

// Calling update 60 times a second
setInterval(update, 1000/fps);

init = function() {
	drawGrid();
	addButtonImages();
	Terrain.list = {};
};

</script>
<body onload = "init()">
	<div id="container"></div>
</body>