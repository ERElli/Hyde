<html>
<head>
    <meta charset="utf-8"/>
	<link rel="stylesheet" type="text/css" href="LevelEditorStyling.css">
	<!-- <script src="jquery-3.3.1.min.js"></script> -->

</head>
<body>
	<div id ="container" style="display:none; "></div>
	<div id ="levelMaker" style="display:none; width:500px; height:40px; position:absolute; top:700px; left:10;";>
		<form action ="#" id="form" onsubmit="map.convertToString()">
			Level Name: <input type="text" id="levelName"><br>
			<input type="submit" value="Submit">
		</form>
    	<p id="newLevelName"> Level </p>
    	<button id="button1" > Save </button>
      	<button id="button2"> Save  and Test</button>
	</div>

 	<div id="enemiesDropdown" style="display:none; ">
		<button onclick="typeTapped('enemies')" id="enemiesbtn"></button>
		<div id="enemies" class="dropdown-content">
			<button style="background-image: url(../client/interface/img/levelEditor/buttons/enemy/basicEnemyDrop.png)" onclick="enemyTapped('Basic Enemy')" class="enemy1btn"></button>
			<button style="background-image: url(../client/interface/img/levelEditor/buttons/enemy/flyingEnemyDrop.png)" onclick="enemyTapped('Flying Enemy')" class="enemy2btn"></button>
			<button style="background-image: url(../client/interface/img/levelEditor/buttons/enemy/shieldEnemyDrop.png)" onclick="enemyTapped('Tank Enemy')" class="enemy3btn"></button>
		</div>
	</div>

	<div id="musicDropdown" style="display:none; ">
		<button onclick="typeTapped('music')" id="musicbtn"></button>
		<div id="music" class="dropdown-content">
			<button style="background-image: url(../client/interface/img/levelEditor/buttons/music/music1Drop.png)" onclick="self.musicTapped('music1')" class="music1btn"></button>
			<button style="background-image: url(../client/interface/img/levelEditor/buttons/music/music2Drop.png)" onclick="self.musicTapped('music2')" class="music2btn"></button>
			<button style="background-image: url(../client/interface/img/levelEditor/buttons/music/music3Drop.png)" onclick="self.musicTapped('music3')" class="music3btn"></button>
		</div>
	</div>

	<div id="backgroundDropdown" style="display:none; ">
		<button onclick="typeTapped('backgrounds')" id="backgroundbtn"></button>
		<div id="backgrounds" class="dropdown-content">
			<button style="background-image: url(../client/interface/img/levelEditor/buttons/world/world1Drop.png)" onclick="worldTapped('world1')" class="world1btn"></button>
			<button style="background-image: url(../client/interface/img/levelEditor/buttons/world/world2Drop.png)" onclick="worldTapped('world2')" class="world2btn"></button>
			<button style="background-image: url(../client/interface/img/levelEditor/buttons/world/world3Drop.png)" onclick="worldTapped('world3')" class="world3btn"></button>
	  	</div>
	</div>

	<div id="checkpointDropdown" style="display:none; ">
		<button onclick="typeTapped('checkpoints')" id="checkpointbtn"></button>
		<div id="checkpoints" class="dropdown-content">
			<button style="background-image: url(../client/interface/img/levelEditor/buttons/checkpoint/checkpointDrop.png)" onclick="checkpointTapped('standard checkpoint')" class="checkpoint1btn"></button>
			<button style="background-image: url(../client/interface/img/levelEditor/buttons/checkpoint/checkpointFinishDrop.png)" onclick="checkpointTapped('final checkpoint')" class="checkpoint2btn"></button>
		</div>
	</div>

	<div id="characterDropdown" style="display:none; ">
		<button onclick="typeTapped('character')" id="characterbtn"></button>
		<div id="character" class="dropdown-content">
			<a href="#World1">World 1</a>
			<a href="#World2">World 2</a>
			<a href="#World3">World 3</a>
		</div>
	</div>

	<div id="terrainDropdown" style="display:none; ">
		<button onclick="typeTapped('terrains')" id="terrainbtn"></button>
		<div id="terrains" class="dropdown-content">
			<button style="background-image: url('../client/interface/img/levelEditor/buttons/terrain/1x1Drop.png')" onclick="terrainTapped('1x1')" class="terrain1btn"></button>
			<button style="background-image: url('../client/interface/img/levelEditor/buttons/terrain/1x1BDrop.png')" onclick="terrainTapped('1x1Breakable')" class="terrain2btn"></button>
			<button style="background-image: url(../client/interface/img/levelEditor/buttons/terrain/3x2Drop.png)" onclick="terrainTapped('3x2')" class="terrain3btn"></button>
			<button style="background-image: url(../client/interface/img/levelEditor/buttons/terrain/3x2BDrop.png)" onclick="terrainTapped('3x2Breakable')" class="terrain4btn"></button>
			<button style="background-image: url(../client/interface/img/levelEditor/buttons/terrain/3x4Drop.png)" onclick="terrainTapped('3x4')" class="terrain5btn"></button>
			<button style="background-image: url(../client/interface/img/levelEditor/buttons/terrain/3x4BDrop.png)" onclick="terrainTapped('3x4Breakable')" class="terrain6btn"></button>
			<button style="background-image: url(../client/interface/img/levelEditor/buttons/terrain/3x6Drop.png)" onclick="terrainTapped('3x6')" class="terrain7btn"></button>
			<button style="background-image: url(../client/interface/img/levelEditor/buttons/terrain/3x6BDrop.png)" onclick="terrainTapped('3x6Breakable')" class="terrain8btn"></button>
			<button style="background-image: url(../client/interface/img/levelEditor/buttons/terrain/1x6BDrop.png)" onclick="terrainTapped('1x6Breakable')" class="terrain9btn"></button>
			<button style="background-image: url(../client/interface/img/levelEditor/buttons/terrain/topSpikeDrop.png)" onclick="terrainTapped('topSpikeTrap')" class="terrain10btn"></button>
			<button style="background-image: url(../client/interface/img/levelEditor/buttons/terrain/platformDrop.png)" onclick="terrainTapped('platform')" class="terrain11btn"></button>
		</div>
	</div>

	<div id="weaponDropdown" style="display:none; ">
		<button onclick="typeTapped('weapons')" id="weaponbtn"></button>
		<div id="weapons" class="dropdown-content">
			<button style="background-image: url(../client/interface/img/levelEditor/buttons/weapon/pistolDrop.png)" onclick="weaponTapped('pistol')" class="pistolbtn"></button>
			<button style="background-image: url(../client/interface/img/levelEditor/buttons/weapon/assaultDrop.png)" onclick="weaponTapped('assault')" class="assaultbtn"></button>
			<button style="background-image: url(../client/interface/img/levelEditor/buttons/weapon/shottyDrop.png)" onclick="weaponTapped('shotgun')" class="shotgunbtn"></button>
			<button style="background-image: url(../client/interface/img/levelEditor/buttons/weapon/swordDrop.png)" onclick="weaponTapped('sword')" class="swordbtn"></button>
		</div>
	</div>


	<div id="levelMenu"  style=" display:none; margin:0px; padding-top:10%; padding-left:40%;height:500px; background-image: url('/images/newWorldTwoBackground.png')" >

		Level Name: <input id="levelNameField" type="text"></input><br><br>
		<br><br>
		Choose Width (ex: 1200): <input id="widthValue" type="text"></input><br><br>
		<br><br>
		<button id="levelButton">Go to Level Editor</button>
	</div>

	<div id="levelLoad"  style=" display:none; padding-top:10%; padding-left:40%;height:500px;  background-image: url('/images/newWorldTwoBackground.png') " >

		Level Name: <input id="levelNameField2" type="text"></input><br><br>
		<br><br>
		<button id="levelButton2">Load in Level Editor</button>
	</div>

  <div id="levelChoose"  style=" display:none; padding-top:10%; padding-left:40%;height:500px;  background-image: url('/images/newWorldTwoBackground.png') " >
		<p id="theLevels"> Levels go here </p>
		<br><br>
	</div>


	<div id="levelChoice"  style="   padding-top:10%; padding-left:40%;height:500px;  background-image: url('/images/newWorldTwoBackground.png')" >

		<button id="levelNewButton">New Level</button>
		<button id="levelLoadButton">Load Level</button>
    <button id="levelChooseButton">Choose a Level</button>
	</div>
</body>


<script type="text/javascript" src="../client/interface/level.json"></script>
<script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
<!-- <script src="text/javascript" src="testLevel.js"></script> -->
<script type="text/javascript" src="Terrain.js"></script>
<script type="text/javascript" src="Map.js"></script>
<script type="text/javascript" src="EntityFactory.js"></script>
<script type="text/javascript" src="Checkpoint.js"></script>
<script type="text/javascript" src="../client/engine/entity.js"></script>
<script type="text/javascript" src="../client/engine/enemy.js"></script>
<script type="text/javascript" src="../client/engine/weapon.js"></script>
<script type="text/javascript" src="../client/engine/player.js"></script>
<script type="text/javascript" src="../client/engine/usable.js"></script>
<script type="text/javascript" src="../client/interface/GUI.js"></script>
<script type="text/javascript" src="../client/interface/Animation.js"></script>
<script type="text/javascript" src="../client/interface/images.js"></script>


<script>
var socket = io();
var level;
var newLevelName = document.getElementById("newLevelName");
var levelChoose= document.getElementById("levelChoose");
var levelChooseButton = document.getElementById("levelChooseButton");
var levelChoice = document.getElementById("levelChoice");
var levelNameField = document.getElementById('levelNameField');
var widthValue = document.getElementById('widthValue');
var levelButton = document.getElementById('levelButton');
var levelNewButton = document.getElementById('levelNewButton');
var levelLoadButton = document.getElementById('levelLoadButton');
//levelLoad div
var levelLoad = document.getElementById('levelLoad');
var levelNameField2 = document.getElementById('levelNameField2');
var levelLoad = document.getElementById('levelLoad');
var levelButton2 = document.getElementById('levelButton2');
var state;
var theLevels= document.getElementById('theLevels');



levelButton.onclick = function(){
	state = "new";
	if (levelNameField.value ==="" ){
		alert("Please input a name for the level.");
	}
	else{
		socket.emit('newLevel',{width:widthValue.value,  level: levelNameField.value});
    levelMenu.style.display = 'none';
		container.style.display = 'block';
		levelMaker.style.display = 'block';
		enemiesDropdown.style.display = 'inline-block';
		musicDropdown.style.display ='inline-block';
		backgroundDropdown.style.display = 'inline-block';
		checkpointDropdown.style.display = 'inline-block';
		characterDropdown.style.display = 'inline-block';
		terrainDropdown.style.display = 'inline-block';
		weaponDropdown.style.display = 'inline-block';
	}
}

levelButton2.onclick = function(){
  state = "load";
  if (levelNameField2.value ==="" ){
    alert("Please input a name for the level.");
  }
  else{

    socket.emit('levelLoadButton', {level: levelNameField2.value});
    //socket.emit('newLevel',{width:widthValue.value,  level: levelNameField.value});
    levelLoad.style.display = 'none';
    container.style.display = 'block';
    levelMaker.style.display = 'block';
    enemiesDropdown.style.display = 'inline-block';
		musicDropdown.style.display ='inline-block';
		backgroundDropdown.style.display = 'inline-block';
		checkpointDropdown.style.display = 'inline-block';
		characterDropdown.style.display = 'inline-block';
		terrainDropdown.style.display = 'inline-block';
		weaponDropdown.style.display = 'inline-block';
  }
}
levelLoadButton.onclick = function(){
      //socket.emit('levelLoadButton', {level:"hey"});
      levelChoice.style.display = 'none';
      levelLoad.style.display = 'block';
      button2.style.display = 'none';
}
levelChooseButton.onclick = function(){
      //socket.emit('levelLoadButton', {level:"hey"});
      levelChoose.style.display = 'block';
      levelLoad.style.display = 'none';
      levelChoice.style.display = 'none';
      socket.emit('getTheLevels');
}

/// Adding levels here ////
socket.on('receiveLevels' ,function(res){
  var  arrayOfLevels = res.result;
  var num =res.levels.length;
    console.log("in level editor the levels are "+ JSON.stringify(res.levels[0])+ "  num"+ num);

    var toAdd = document.createDocumentFragment();
    for(var i=0; i < num; i++){
       var newDiv = document.createElement('div');
       newDiv.id = 'r'+i;
       var ID  = newDiv.id ;
       newDiv.innerHTML = JSON.stringify(res.levels[i].level);
       console.log("  "+ JSON.stringify(res.levels[i].level));
       newDiv.className = 'ansbox';
       
       newDiv.onclick = function(){console.log('hello '+newDiv.innerHTML );  };

       toAdd.appendChild(newDiv);
    }
    document.getElementById('levelChoose').appendChild(toAdd);
    //document.getElementById(r1).onclick =  function(){
    //  console.log('hello');
    //};

});
var array = ["level 1", "level 2", "level 3"];

//////////////////////////

levelNewButton.onclick = function(){
    //  socket.emit('levelNewButton', {level:"hey"});
      levelChoice.style.display = 'none';
      levelMenu.style.display = 'block';
      button1.style.display = 'none';
}
//newLevelName.innerHTML= "blue";
var button1 = document.getElementById("button1");
var button2 = document.getElementById("button2");
//request
 button1.onclick = function(){
       socket.emit('button', {level:levelNameField2.value});
 }
 button2.onclick = function(){
       socket.emit('button', {level:levelNameField.value});
 }
//receive
 socket.on('result',function(res){
    console.log("result", JSON.parse(JSON.stringify(res)));
      location.href = "/client/interface/index.html";
 });
socket.on('loadIt', function(data){
	console.log("this is cool");
	let level = data;
	console.log("result"+ level);
	var levelObject = EntityFactory(level,false);
	console.log("LEVEL OBJECT",levelObject);
	map = new Map(levelObject.width,HEIGHT,TILE_WIDTH,TILE_HEIGHT);
	for(let type in levelObject){
		console.log("TYPE",levelObject[type]);
		if(type.includes("terrain") || type.includes("enemies") || type.includes("player") || type.includes("weapon")){
			for(let id in levelObject[type]){
				console.log("ID",levelObject[type][id]);
				map.tryToPlaceEntity(levelObject[type][id]);
			}
		}
	}
	updateWidth(parseInt(levelObject.width));
	updateMap(map);
	Update(level);
});

//This will Receive the level objects and set them to the variable level
socket.on('hey', function(data){
  let level = data;
  console.log("result"+ level);
  let levelObject = EntityFactory(level,true);
  console.log("LEVEL OBJECT",levelObject.width);
  var map = Map(levelObject.width,HEIGHT,TILE_WIDTH,TILE_HEIGHT);
  console.log("MAP",map);
  updateWidth(levelObject.width);
  //console.log(levelObject);
  Update(level);
});

updateWidth = function(newWidth){
  console.log("OLD WIDTH", WIDTH);
  WIDTH = newWidth;
  console.log("NEW WIDTH",WIDTH);

};
updateMap = function(newMap){
  console.log("old map",map);
  map = newMap;
  console.log("NEW map",map);
}
var Update = function(level){
	// var l = level;
	 console.log("heeey"+JSON.stringify(level[0] ));
	// for(var i=0; i<l[0].enemies.length; i++){
		//console.log("heeey"+JSON.stringify(level[0].enemies) );
	// }
  // console.log("heeey"+level[0].enemies );
}
if (window.File && window.FileReader && window.FileList && window.Blob) {
  // alert("SUCCESS!");
} else {
  alert('The File APIs are not fully supported in this browser.');
}
//Initial values
var WIDTH = 1250*3;
var HEIGHT = 650*1;
var TILE_WIDTH = 50;
var TILE_HEIGHT = 50;
var rectWIDTH = 50;
var rectHEIGHT = 50;
var buttonStartingX = TILE_WIDTH*5.5;
var mouseLeft = false;
var mouseRight = false;
var offsetX = 0;
var offsetY = 0;
var fps = 60;
var framecount = 0;
var numClicks = 1;
var pathToRoot = "../";
var Img = Img(pathToRoot);
var ani = Animation();
var dropdownDisplayed = false;
var visibleDropdown;
var entity;
var pos;
var id;
var x;
var y;
// //Creating images
var backgroundImage = new Image();
backgroundImage.src = "../../images/worldTwoBackground.png";
//Initializing the map
var map = Map(WIDTH,HEIGHT,TILE_WIDTH,TILE_HEIGHT);
//map.setBackgroundImage(backgroundImage.src);
// let levelObject = EntityFactory(levelString,true);
// console.log(levelObject);

/*
	Controls
*/
var controls = {
	left: false,
	up: false,
	right: false,
	down: false,
};

/*
	Keydown Listener
*/
window.addEventListener("keydown",function(e){
	switch(e.keyCode){
		case 37:
			controls.left = true;
			e.preventDefault();
			break;
		case 38:
			controls.up = true;
			e.preventDefault();
			break;
		case 39:
			controls.right = true;
			e.preventDefault();
			break;
		case 40:
			controls.down = true;
			e.preventDefault();
			break;
	}
});

/*
	Keyup Listener
*/
window.addEventListener("keyup",function(e){
	switch(e.keyCode){
		case 37:
			controls.left = false;
			break;
		case 38:
			controls.up = false;
			break;
		case 39:
			controls.right = false;
			break;
		case 40:
			controls.down = false;
			break;
	}
	e.preventDefault();
});

/*
	Disabling right-click context menu
*/
document.oncontextmenu = function(mouse){
	mouse.preventDefault();
};

/*
	Performs pressed actions when controls are being pressed
*/
doPressedAction = function() {
	if(controls.left){
		translateCanvases(-offsetX,-offsetY);
		(offsetX===0)? offsetX = 0 : (offsetX += TILE_WIDTH);
		translateCanvases(offsetX,offsetY);
		gui.editorBackground(offsetX,offsetY,self.selectedBackground);
	}
	if(controls.right){
		translateCanvases(-offsetX,-offsetY);
		(offsetX===(gui.bg.width-WIDTH))? (offsetX = gui.bg.width-WIDTH) : offsetX -= TILE_WIDTH;
		translateCanvases(offsetX,offsetY);
		gui.editorBackground(offsetX,offsetY,self.selectedBackground);
	}
	if(controls.up){
		translateCanvases(-offsetX,-offsetY);
		(offsetY===0)? offsetY = 0 : (offsetY += TILE_HEIGHT);
		translateCanvases(offsetX,offsetY);
		gui.editorBackground(offsetX,offsetY,self.selectedBackground);
	}
	if(controls.down){
		translateCanvases(-offsetX,-offsetY);
		(offsetY===gui.bg.height-HEIGHT)? (offsetY = gui.bg.height-HEIGHT) : offsetY -= TILE_HEIGHT;
		translateCanvases(offsetX,offsetY);
		gui.editorBackground(offsetX,offsetY,self.selectedBackground);
	}
};

translateCanvases = function(xOffset,yOffset){
	gui.fg_ctx.translate(xOffset,yOffset);
	gui.ep_ctx.translate(xOffset,yOffset);
};

var entity;
//Drawing a preview of the object to be placed on the level
//and snapping the top right corner of the preview to the grid lines
snapToGrid  = function(canvas,mouse){
	var pos = getMousePosition(canvas,mouse);
	var prev_x = pos.x - (pos.x % TILE_HEIGHT)-offsetX;
	var prev_y = pos.y - (pos.y % TILE_WIDTH)-offsetY;
	entity = null;
	var tempID = 0;
	var tempTarget = Player(tempID,0,0,0,0,null,false);
	var previewImage = new Image();
	switch(self.selectedButton){
		case 'enemies':
				switch(self.selectedEnemy){
				case "Basic Enemy":
					entity = BasicEnemy(tempID,prev_x,prev_y,0,0,Img.basicEnemy1,'red',null);
					break;
				case "Flying Enemy":
					entity = FlyingEnemy(tempID,prev_x,prev_y,0,0,Img.basicEnemy2,'red',null);
					break;
				case "Tank Enemy":
					entity = TankEnemy(tempID,prev_x,prev_y,0,0,Img.basicEnemy3,'red',null);
					break;
			}
			entity.draw(gui.ep_ctx,true);
			break;
		case 'checkpoints':
			switch(self.selectedCheckpoint){
				case "standard checkpoint":
					entity = StandardCheckpoint(tempID,prev_x,prev_y);
					break;
				case "final checkpoint":
					entity = FinalCheckpoint(tempID,prev_x,prev_y);
					break;
			}
			entity.draw(gui.ep_ctx,true);
			break;
		case 'character':
			entity = Player(tempID,prev_x,prev_y,0,0,Img.playerSmall,null,false);
			entity.draw(gui.ep_ctx,true);
			break;
		case 'terrains':
			switch(self.selectedTerrain){
				case "1x1":
					entity = Terrain1x1(tempID,prev_x,prev_y);
					break;
				case "1x1Breakable":
					entity = Terrain1x1Breakable(tempID,prev_x,prev_y);
					break;
				case "3x2":
					entity = Terrain3x2(tempID,prev_x,prev_y);
					break;
				case "3x2Breakable":
					entity = Terrain3x2Breakable(tempID,prev_x,prev_y);
					break;
				case "3x4":
					entity = Terrain3x4(tempID,prev_x,prev_y);
					break;
				case "3x4Breakable":
					entity = Terrain3x4Breakable(tempID,prev_x,prev_y);
					break;
				case "3x6":
					entity = Terrain3x6(tempID,prev_x,prev_y);
					break;
				case "3x6Breakable":
					entity = Terrain3x6Breakable(tempID,prev_x,prev_y);
					break;
				case "1x6Breakable":
					entity = Terrain1x6Breakable(tempID,prev_x,prev_y);
					break;
				case "topSpikeTrap":
					entity = SpikeTrap(tempID, prev_x, prev_y, 0, 0, 50, 50, Img.topSpikeTrap,'red', 20,'vertical');
					break;
				case "platform":
					entity = MovingPlatform(tempID, prev_x, prev_y, 0, 0, 50, 50, Img.platform, 'red', null, 5);
					break;
			}
			entity.draw(gui.ep_ctx,true);
			break;
		case 'weapons':
			switch(self.selectedWeapon){
	    		case "pistol":
	    			entity = WeaponPickUp(tempID,prev_x,prev_y,"pistol",tempTarget);
	    			break;
	    		case "assault":
	    			entity = WeaponPickUp(tempID,prev_x,prev_y,"assaultRifle",tempTarget);
	    			break;
	    		case "shotgun":
	    			entity = WeaponPickUp(tempID,prev_x,prev_y,"shotgun",tempTarget);
	    			break;
	    		case "sword":
	    			entity = WeaponPickUp(tempID,prev_x,prev_y,"sword",tempTarget);
	    			break;
	    	}
	    	entity.draw(gui.ep_ctx,true);
			break;
		default:
			gui.ep_ctx.fillRect(x,y,TILE_WIDTH,TILE_HEIGHT);
			break;
	}
};

//function to place entity on the map
putEntity = function() {
	var mouseBelowUpperBound = pos.x<gui.fg.width && pos.y<gui.fg.height+(2*TILE_HEIGHT);
	var mouseAboveLowerBound = pos.x>0 && pos.y>TILE_HEIGHT*2;
	var tempTarget = Player(0,0,0,0,0,null,false);
	id = Math.random();
	if(mouseBelowUpperBound && mouseAboveLowerBound){
		if(((x+entity.width) <= WIDTH) && ((y+entity.height) <= HEIGHT) && !dropdownDisplayed){
			switch(self.selectedButton){
				case 'enemies':
					switch(self.selectedEnemy){
						case 'Basic Enemy':
							entity = BasicEnemy(id,x,y,0,0,Img.basicEnemy1,'red',null);
							break;
						case 'Flying Enemy':
							entity = FlyingEnemy(id,x,y,0,0,Img.basicEnemy2,'red',null);
							break;
						case 'Tank Enemy':
							entity = TankEnemy(id,x,y,0,0,Img.bearEnemy,'red',null);
							break;
					}
					break;
				case 'checkpoints':
					switch(self.selectedCheckpoint){
						case 'standard checkpoint':
							entity = StandardCheckpoint(id,x,y);
							break;
						case 'final checkpoint':
							entity = FinalCheckpoint(id,x,y);
							break;
					}
					break;
				case 'character':
					entity = Player(id,x,y,0,0,Img.playerSmall,null,false);
					break;
				case 'terrains':
					switch(self.selectedTerrain){
						case '1x1':
							entity = Terrain1x1(id,x,y);
							break;
						case '1x1Breakable':
							entity = Terrain1x1Breakable(id,x,y);
							break;
						case '3x2':
							entity = Terrain3x2(id, x, y);
							break;
						case '3x2Breakable':
							entity = Terrain3x2Breakable(id, x, y);
							break;
						case '3x4':
							entity = Terrain3x4(id, x, y);
							break;
						case '3x4Breakable':
							entity = Terrain3x4Breakable(id, x, y);
							break;
						case '3x6':
							entity = Terrain3x6(id, x, y);
							break;
						case '3x6Breakable':
							entity = Terrain3x6Breakable(id, x, y);
							break;
						case '1x6Breakable':
							entity = Terrain1x6Breakable(id, x, y);
							break;
						case 'topSpikeTrap':
							entity = SpikeTrap(id, x, y, 0, 0, 50, 50, Img.topSpikeTrap, 'red', 20, 'vertical');
							break;
						case 'platform':
							entity = MovingPlatform(id, startPos.x,startPos.y , 0, 0, 50, 50, Img.platform, 'red', endPos, 5);
							break;
					}
					break;
				case 'weapons':
					switch(self.selectedWeapon){
						case 'pistol':
							entity = WeaponPickUp(id,x,y,"pistol",tempTarget);
							break;
						case 'assault':
							entity = WeaponPickUp(id,x,y,"assaultRifle",tempTarget);
							break;
						case 'shotgun':
							entity = WeaponPickUp(id,x,y,"shotgun",tempTarget);
							break;
						case 'sword':
							entity = WeaponPickUp(id,x,y,"sword",tempTarget);
							break;
					}
					break;
				default:
					console.log("No entity selected");
					break;
			}
			map.tryToPlaceEntity(entity);
		}else{
			console.log("Can not place object there");
		}
	}
};

deleteEntity = function() {
	var mouseBelowUpperBound = pos.x<gui.fg.width && pos.y<gui.fg.height+(2*TILE_HEIGHT);
	var mouseAboveLowerBound = pos.x>0 && pos.y>TILE_HEIGHT*2;
	if(mouseBelowUpperBound && mouseAboveLowerBound){
		map.removeEntity(x,y);
	}
};

updateLevel = function() {
	gui.fg_ctx.clearRect(0,0,WIDTH,HEIGHT);
	map.update();
	doPressedAction();
	framecount++;
};

// Calling update 60 times a second
setInterval(updateLevel, 1000/fps);
getMousePosition = function(canvas,mouse){
	var rect = canvas.getBoundingClientRect();
	return {
		x: mouse.clientX - rect.left,
		y: mouse.clientY - rect.top,
	};
};

var startPos = {};
var endPos = {};
doMouseAction = function(){
	if(mouseLeft){
		x = pos.x - (pos.x % TILE_HEIGHT) - offsetX;
		y = pos.y - (pos.y % TILE_WIDTH) - offsetY;
		if((self.selectedButton === 'terrains') && (self.selectedTerrain === 'platform') && !dropdownDisplayed){
			if(numClicks == 1){
				startPos.x = x;
				startPos.y = y;
				var platform = MovingPlatform(0, startPos.x, startPos.y, 0, 0, 50, 50, '', '', null, null);
				gui.ep_ctx.fillStyle="#FF0000";
				//top left area
				gui.ep_ctx.fillRect(0,100,startPos.x,startPos.y-100);
				//top right area
				gui.ep_ctx.fillRect(startPos.x+platform.width,100,WIDTH-startPos.x-platform.width,startPos.y-100);
				//bottom left area
				gui.ep_ctx.fillRect(0,startPos.y+platform.height,startPos.x,HEIGHT-startPos.y);
				//bottom right area
				gui.ep_ctx.fillRect(startPos.x+platform.width,startPos.y+platform.height,WIDTH-startPos.x-platform.width,HEIGHT-startPos.y);
				numClicks++;
				console.log("FIRST CLICK at",startPos);
			}else if(numClicks == 2){
				if(x==startPos.x || y == startPos.y){
					endPos.x = x;
					endPos.y = y;
					putEntity();
					console.log("SECOND CLICK at", endPos);
				}else{
					gui.ep_ctx.clearRect(0,0,gui.ep.width,gui.ep.height);
					console.log("NOT VALID FINAL POSITION");
				}
				
				numClicks = 1;
			}
		}else{
			putEntity();
		}
		// if(self.selectedEnemy ==='Flying Enemy'){
		// 	if(numClicks===1){
		// 		console.log("1st CLICK",numClicks);
		// 		finalPos = pos;
		// 		self.selectedButton = null;
		// 		console.log("FINAL POS",finalPos);
		// 	}
		// 	if(numClicks===2){
		// 		console.log("2nd CLICK",numClicks);
		// 		pathStart = pos;
		// 		console.log("PATH START",pathStart);
		// 	}
		// 	if(numClicks===3){
		// 		console.log("3rd CLICK",numClicks);
		// 		pathEnd = pos;
		// 		console.log("PATH END",pathEnd);
		// 		numClicks = 0;
		// 		self.selectedButton = "enemies";
		// 	}
		// 	numClicks++;
		// } else {
			// putEntity();
		// }		
	} else if(mouseRight){
		if((self.selectedButton === 'terrains') && (self.selectedTerrain === 'platform') && numClicks != 1){
			numClicks = 1;
		}else{
			deleteEntity();
		}
	}
}
document.onmousemove = function(mouse){
	pos = getMousePosition(gui.bg,mouse);
	x = pos.x - (pos.x % TILE_HEIGHT) - offsetX;
	y = pos.y - (pos.y % TILE_WIDTH) - offsetY;
	var mouseBelowUpperBound = pos.x<WIDTH && pos.y<HEIGHT;
	var mouseAboveLowerBound = pos.x>0 && pos.y>TILE_HEIGHT*2;
	if(mouseBelowUpperBound && mouseAboveLowerBound){
		if(numClicks == 1){
			gui.ep_ctx.clearRect(0,0,WIDTH,HEIGHT);
			snapToGrid(ep,mouse);
		}
		doMouseAction();
	}
};
document.onmousedown = function(mouse){
	(mouse.which===1) ? (mouseLeft = true) : (mouseRight = true);
	pos = getMousePosition(bg,mouse);
	x = pos.x - (pos.x % TILE_HEIGHT) - offsetX;
	y = pos.y - (pos.y % TILE_WIDTH) - offsetY;
	var mouseBelowUpperBound = pos.x<WIDTH && pos.y<HEIGHT;
	var mouseAboveLowerBound = pos.x>0 && pos.y>TILE_HEIGHT*2;
	if(mouseBelowUpperBound && mouseAboveLowerBound){
		doMouseAction();
	}
};
document.onmouseup = function(mouse){
	(mouse.which===1) ? (mouseLeft = false) : (mouseRight = false);
};
//Drawing Grid lines
drawGrid = function(){
	gui.gr_ctx.globalAlpha = 0.05;
	gui.gr_ctx.lineWidth = 2;
	gui.gr_ctx.strokeStyle = "#515151";
	//Drawing vertical lines
	for(x=TILE_WIDTH; x<=WIDTH; x+=TILE_WIDTH){
		gui.gr_ctx.moveTo(x,TILE_HEIGHT*2);	//The first 2 rows of the canvas are used by buttons
		gui.gr_ctx.lineTo(x,HEIGHT);
		gui.gr_ctx.stroke();
	}
	//Drawing horizontal lines
	for(y=TILE_HEIGHT*2; y<=HEIGHT; y+=TILE_HEIGHT){
		gui.gr_ctx.moveTo(0,y);
		gui.gr_ctx.lineTo(WIDTH,y);
		gui.gr_ctx.stroke();
	}
	gui.gr_ctx.globalAlpha = 1;
};
init = function() {
	container = document.getElementById("container");
	gui = GUI(container);
	gui.createCanvas(1250,650);
	drawGrid();
};
init();
/***********************
DROP DOWN FUNCTIONALITY
***********************/
self.selectedButton = null;
self.selectedEnemy = null;
self.selectedBackground = null;
self.selectedCheckpoint = null;
self.selectedCharacter = null;
self.selectedTerrain = null;
self.selectedWeapon = null;
/*
	Toggles style.display of an element
*/
function toggleDisplay(element) {
	// console.log("BEFORE",element.style.display,dropdownDisplayed,visibleDropdown);
	if(element.style.display != 'block' ){
		element.style.display = 'block';
		dropdownDisplayed = true;
		visibleDropdown = element.id;
	} else {
		element.style.display = 'none';
		dropdownDisplayed = false;
		visibleDropdown = "";
	}
	// console.log("AFTER",element.style.display,dropdownDisplayed,visibleDropdown);
}
/*
	Detects what button is pressed and toggles the style.display of the corresponding
	dropdown menu
*/
function typeTapped(id){
	// console.log("TYPE TAPPED",id);
	self.selectedButton = id;
	if(id !== 'character'){
		let element = document.getElementById(id);
		toggleDisplay(element);
		// visibleDropdown = element.id;
	}
}
window.onclick = function(event){
	// console.log("CLASSNAME",event.target);
	target = event.target.parentElement.className;
	// console.log(target);
	if(!target.includes("dropdown-content")){
		if(dropdownDisplayed){
			// console.log(dropdownDisplayed);
		}
		// var dropdowns = document.getElementsByClassName("dropdown-content");
		// for(let i=0; i<dropdowns.length; i++){
		// 	var openDropdown = dropdowns[i];
		// 	openDropdown.style.display = 'none';
		// }
	}else{
		// console.log("DROPDOWN");
	}
}
/*************************
	Enemies
**************************/
// Close the enemies dropdown if the user clicks outside of it
// document.onclick = function(event) {
// 	var divToHide = document.getElementById("myEnemiesDropdown");
// 	if (!event.target.matches('.enemiesbtn')) {
// 		if(divToHide.style.display === 'block'){
// 			divToHide.style.display = 'none';
// 		}
// 	}
// }
self.enemyTapped = function(id){
	self.selectedEnemy = id;
	console.log(self.selectedEnemy);
	let parent = document.getElementById('enemies')
	toggleDisplay(parent);
}
/*************************
	Music
**************************/
// Close the enemies dropdown if the user clicks outside of it
// document.onclick = function(event) {
//   	var divToHide = document.getElementById("myMusicDropdown");
// 	if (!event.target.matches('.musicbtn')) {
// 		if(divToHide.style.display === 'block'){
// 			divToHide.style.display = 'none';
// 		}
// 	}
// }


self.musicTapped = function(id){
  self.selectedMusic = id;
  let parent = document.getElementById("music");
  toggleDisplay(parent);
}



/*************************
	Background
**************************/
// // Close the enemies dropdown if the user clicks outside of it
// document.onclick = function(event) {
// 	let divToHide = document.getElementById("backgrounds");
// 	if (!event.target.matches('.backgroundbtn')) {
// 		if(divToHide.style.display === 'block'){
// 			divToHide.style.display = 'none';
// 		}
// 	}
// }
self.worldTapped = function(id){
	self.selectedBackground = id;
  //console.log("this is so awesome");
  //socket.emit('addBackgroundItem',{background:self.selectedBackground,  });
	console.log(self.selectedBackground);
	map.setBackground = id;
  map.setBackgroundImage(id);
	gui.editorBackground(offsetX,offsetY,self.selectedBackground);

	let parent = document.getElementById('backgrounds');
	toggleDisplay(parent);
}
/*************************
	Checkpoint
**************************/
/* When the user clicks on the button,
toggle between hiding and showing the dropdown content */
function checkpointTapped(id) {
	self.selectedCheckpoint = id;
	console.log(id);

	let parent = document.getElementById('checkpoints');
	toggleDisplay(parent);
}
// window.onclick = function(event) {
// 	var divToHide = document.getElementById("checkpointDropdown");
// 	if (!event.target.matches('.checkpointbtn')) {
// 		if(divToHide.style.display === 'block'){
// 			divToHide.style.display = 'none';
// 		}
// 	}
// }
/*************************
	Character
**************************/
/* When the user clicks on the button,
toggle between hiding and showing the dropdown content */
function characterTapped() {
	self.selectedButton = "character";
	var element = document.getElementById("characterDropdown");
	toggleDisplay(element);
}
// window.onclick = function(event) {
// 	var divToHide = document.getElementById("characterDropdown");
// 	if (!event.target.matches('.characterbtn')) {
// 		if(divToHide.style.display === 'block'){
// 			divToHide.style.display = 'none';
// 		}
// 	}
// }
/*************************
	Terrain
**************************/
// Close the Terrain dropdown if the user clicks outside of it
// window.onclick = function(event) {
// 	var divToHide = document.getElementById("myTerrainDropdown");
// 	if (!event.target.matches('.terrainbtn')) {
// 		if(divToHide.style.display === 'block'){
// 			divToHide.style.display = 'none';
// 		}
// 	}
// }


function terrainTapped(id){
	console.log(id);
	self.selectedTerrain = id;

	var parent = document.getElementById('terrains');
	toggleDisplay(parent);
}
/* When the user clicks on the button,
toggle between hiding and showing the dropdown content */

// function weaponTapped() {
// 	self.selectedButton = "weapon";
// 	var element = document.getElementById("myWeaponDropdown");
// 	toggleDisplay(element);
// }

// Close the weapon dropdown if the user clicks outside of it
// window.onclick = function(event) {
// 	var divToHide = document.getElementById("weapons");
// 	if (!event.target.matches('.weaponbtn')) {
// 		if(divToHide.style.display === 'block'){
// 			divToHide.style.display = 'none';
// 		}
// 	}
// }
self.weaponTapped = function(id){
	self.selectedWeapon = id;
	console.log(self.selectedWeapon);

	var parent = document.getElementById('weapons');
	toggleDisplay(weapons);
}
</script>
</html>
