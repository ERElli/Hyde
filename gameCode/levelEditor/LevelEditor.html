
<body>
	<div id ="container">
  		<canvas id="background" width="1250" height="650"  style="position: absolute; left: 0; top: 0; z-index: 0;"></canvas>
 		<canvas id="entityPreview" width="1250" height="650" style="position: absolute; left: 0; top: 0; z-index: 2;"></canvas>
  		<canvas id="grid" width="1250" height="650" style="position: absolute; left:0; top: 0; z-index: 3;"></canvas>
  		<canvas id="levelground" width="1250" height="650"  style="position: absolute; left: 0; top: 0; z-index: 1;"></canvas>
 	</div>

 	<div class="enemiesDropdown">
		<button onclick="enemiesTapped()" class="enemiesbtn"></button>
		<div id="myEnemiesDropdown" class="enemies-content">
			<button style="background-image: url(../../images/enemy1Drop.png)" onclick="enemy1Tapped()" class="enemy1btn"></button>
			<button style="background-image: url(../../images/enemy2Drop.png)" onclick="enemy2Tapped()" class="enemy2btn"></button>
			<button style="background-image: url(../../images/enemy3Drop.png)" onclick="enemy3Tapped()" class="enemy3btn"></button>
		</div>
	</div>

	<div class="musicDropdown">
		<button onclick="musicTapped()" class="musicbtn"></button>
		<div id="myMusicDropdown" class="music-content">
			<button style="background-image: url(../../images/music1Drop.png)" onclick="self.music1Tapped()" class="music1btn"></button>
			<button style="background-image: url(../../images/music2Drop.png)" onclick="self.music2Tapped()" class="music2btn"></button>
			<button style="background-image: url(../../images/music3Drop.png)" onclick="self.music3Tapped()" class="music3btn"></button>
		</div>
	</div>

	<div class="backgroundDropdown">
		<button onclick="backgroundTapped()" class="backgroundbtn"></button>
		<div id="myBackgroundDropdown" class="background-content">
			<button style="background-image: url(../../images/world1Drop.png)" onclick="world1Tapped()" class="world1btn"></button>
			<button style="background-image: url(../../images/world2Drop.png)" onclick="world2Tapped()" class="world2btn"></button>
			<button style="background-image: url(../../images/world3Drop.png)" onclick="world3Tapped()" class="world3btn"></button>
	  	</div>
	</div>

	<div class="checkpointDropdown">
		<button onclick="checkpointTapped()" class="checkpointbtn"></button>
		<div id="checkpointDropdown" class="checkpoint-content">
			<a href="#World1">World 1</a>
			<a href="#World2">World 2</a>
			<a href="#World3">World 3</a>
		</div>
	</div>

	<div class="characterDropdown">
		<button onclick="characterTapped()" class="characterbtn"></button>
		<div id="characterDropdown" class="character-content">
			<a href="#World1">World 1</a>
			<a href="#World2">World 2</a>
			<a href="#World3">World 3</a>
		</div>
	</div>

	<div class="terrainDropdown">
		<button onclick="terrainTapped()" class="terrainbtn"></button>
		<div id="myTerrainDropdown" class="terrain-content">
			<button style="background-image: url(../../images/3x2Drop.png)" onclick="terrain1Tapped()" class="terrain1btn"></button>
			<button style="background-image: url(../../images/3x2BDrop.png)" onclick="terrain2Tapped()" class="terrain2btn"></button>
			<button style="background-image: url(../../images/3x4Drop.png)" onclick="terrain3Tapped()" class="terrain3btn"></button>
			<button style="background-image: url(../../images/3x4BDrop.png)" onclick="terrain4Tapped()" class="terrain4btn"></button>
			<button style="background-image: url(../../images/3x6Drop.png)" onclick="terrain5Tapped()" class="terrain5btn"></button>
			<button style="background-image: url(../../images/3x6BDrop.png)" onclick="terrain6Tapped()" class="terrain6btn"></button>
		</div>
	</div>

	<div class="weaponDropdown">
		<button onclick="weaponTapped()" class="weaponbtn"></button>
  		<div id="myWeaponDropdown" class="weapon-content">
			<button style="background-image: url(../../images/pistolDrop.png)" onclick="pistolTapped()" class="pistolbtn"></button>
			<button style="background-image: url(../../images/assaultDrop.png)" onclick="assaultTapped()" class="assaultbtn"></button>
			<button style="background-image: url(../../images/shottyDrop.png)" onclick="shotgunTapped()" class="shotgunbtn"></button>
			<button style="background-image: url(../../images/swordDrop.png)" onclick="swordTapped()" class="swordbtn"></button>
   		</div>
	</div>

</body>




<script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
<script type="text/javascript" src="/gameCode/levelEditor/Map.js"></script>
<script type="text/javascript" src="/gameCode/levelEditor/Terrain.js"></script>
<script type="text/javascript" src="/gameCode/levelEditor/Rectangle.js"></script>
<script type="text/javascript" src="/gameCode/levelEditor/Enemy.js"></script>


<script>
var bg = document.getElementById("background");
var ep = document.getElementById("entityPreview");
var lg = document.getElementById("levelground");
var gr = document.getElementById("grid");

var ctx_bg = bg.getContext("2d");
var ctx_lg = lg.getContext("2d");
var ctx_ep = ep.getContext("2d");
var ctx_gr = gr.getContext("2d");

//This makes the preview of the entity transparent
ctx_ep.globalAlpha = 0.5;

//Initial values

var WIDTH = 1250*2;
var HEIGHT = 650*2;
var TILE_WIDTH = 50;
var TILE_HEIGHT = 50;
var rectWIDTH = 50*2;
var rectHEIGHT = 50*2;
var buttonStartingX = TILE_WIDTH*5.5;
var mouseLeft = false;
var mouseRight = false;
var offsetX = 0;
var offsetY = 0;
var fps = 20;

//Creating images
var backgroundImage = new Image();
backgroundImage.src = "../../images/worldTwoBackground.png";

var enemyButtonImage = new Image();
enemyButtonImage.src = "../../images/enemiesButton.png";

var musicButtonImage = new Image();
musicButtonImage.src = "../../images/musicButton.png";

var backgroundButtonImage = new Image();
backgroundButtonImage.src = "../../images/backgroundButton.png";

var checkPointButtonImage = new Image();
checkPointButtonImage.src = "../../images/checkPointButton.png";

var characterButtonImage = new Image();
characterButtonImage.src = "../../images/characterButton.png";

var terrainButtonImage = new Image();
terrainButtonImage.src = "../../images/terrainButton.png";

var weaponButtonImage = new Image();
weaponButtonImage.src = "../../images/weaponButton.png";

//Initializing the map
var map = Map(WIDTH,HEIGHT,TILE_WIDTH,TILE_HEIGHT);
map.setBackgroundImage(backgroundImage.src);

//Controls
var controls = {
	left: false,
	up: false,
	right: false,
	down: false,
};

window.addEventListener("keydown",function(e){
	switch(e.keyCode){
		case 37:
			controls.left = true;
			e.preventDefault();
			break;
		case 38:
			controls.up = true;
			e.preventDefault();
			break;
		case 39:
			controls.right = true;
			e.preventDefault();
			break;
		case 40:
			controls.down = true;
			e.preventDefault();
			break;
	}
});

window.addEventListener("keyup",function(e){
	switch(e.keyCode){
		case 37:
			controls.left = false;
			break;
		case 38:
			controls.up = false;
			break;
		case 39:
			controls.right = false;
			break;
		case 40:
			controls.down = false;
			break;
	}
	e.preventDefault();
});


doPressedAction = function() {
	if(controls.left){
		ctx_lg.translate(-offsetX,-offsetY);
		(offsetX===0)? offsetX = 0 : (offsetX += TILE_WIDTH);
		ctx_lg.translate(offsetX,offsetY);
		drawBackground();
	}
	if(controls.right){
		ctx_lg.translate(-offsetX,-offsetY);
		(offsetX===(background.width-WIDTH))? (offsetX = background.width-WIDTH) : offsetX -= TILE_WIDTH;
		ctx_lg.translate(offsetX,offsetY);
		drawBackground();
	}
	if(controls.up){
		ctx_lg.translate(-offsetX,-offsetY);
		(offsetY===0)? offsetY = 0 : (offsetY += TILE_HEIGHT);
		ctx_lg.translate(offsetX,offsetY);
		drawBackground();
	}
	if(controls.down){
		ctx_lg.translate(-offsetX,-offsetY);
		(offsetY===(background.height-HEIGHT))? (offsetY = background.height-HEIGHT) : offsetY -= TILE_HEIGHT;
		ctx_lg.translate(offsetX,offsetY);
		drawBackground();
	}
	if(mouseLeft){
		putEntity();
	}
	if(mouseRight){
		deleteEntity();
	}
};



/***********************

DROP DOWN FUNCTIONALITY

***********************/

self.selectedButton = null;
self.selectedEnemy = null;
self.selectedBackground = null;
self.selectedCharacter = null;
self.selectedTerrain = null;
self.selectedWeapon = null;

//Function to show and hide elements
function toggleDisplay(element) {
	if(element.style.display != 'block'){
		element.style.display = 'block';
	} else {
		element.style.display = 'none';
	}
}

/*************************
	Enemies
**************************/

/* When the user clicks on the button,
toggle between hiding and showing the dropdown content */
function enemiesTapped() {
    self.selectedButton = "enemies";
    let element = document.getElementById("myEnemiesDropdown");
    toggleDisplay(element);
}

// Close the enemies dropdown if the user clicks outside of it
document.onclick = function(event) {
	var divToHide = document.getElementById("myEnemiesDropdown");
	if (!event.target.matches('.enemiesbtn')) {
		if(divToHide.style.display === 'block'){
			divToHide.style.display = 'none';
		}
	}
}

self.enemy1Tapped = function(){
  self.selectedEnemy = "enemy1";
}

self.enemy2Tapped = function(){
  self.selectedEnemy = "enemy2";
}

self.enemy3Tapped = function(){
  self.selectedEnemy = "enemy3";
}

/*************************
	Music
**************************/

/* When the user clicks on the button,
toggle between hiding and showing the dropdown content */
function musicTapped() {
    self.selectedButton = "music";
    var element = document.getElementById("myMusicDropdown");
    toggleDisplay(element);
}

// Close the enemies dropdown if the user clicks outside of it
document.onclick = function(event) {
  	var divToHide = document.getElementById("myMusicDropdown");
	if (!event.target.matches('.musicbtn')) {
		if(divToHide.style.display === 'block'){
			divToHide.style.display = 'none';
		}
	}
}

self.music1Tapped = function(){
  self.selectedMusic = "music1";
}

self.music2Tapped = function(){
  self.selectedMusic = "music2";
}

self.enemy3Tapped = function(){
  self.selectedMusic = "music3";
}

/*************************
	Background
**************************/

/* When the user clicks on the button,
toggle between hiding and showing the dropdown content */
function backgroundTapped() {
	self.selectedButton = "background"
	var element = document.getElementById("myBackgroundDropdown");
    toggleDisplay(element);
}

// Close the enemies dropdown if the user clicks outside of it
document.onclick = function(event) {
	let divToHide = document.getElementById("myBackgroundDropdown");
	if (!event.target.matches('.backgroundbtn')) {
		if(divToHide.style.display === 'block'){
			divToHide.style.display = 'none';
		}
	}
}

self.world1Tapped = function(){
	self.selectedBackground = "world1";
	drawBackground();
}

self.world2Tapped = function(){
	self.selectedBackground = "world2";
	drawBackground();
}

self.world3Tapped = function(){
	self.selectedBackground = "world3";
	drawBackground();
}

/*************************
	Checkpoint
**************************/

/* When the user clicks on the button,
toggle between hiding and showing the dropdown content */
function checkpointTapped() {
	self.selectedButton = "checkpoint";
	var element = document.getElementById("checkpointDropdown");
	toggleDisplay(element);
}

window.onclick = function(event) {
	var divToHide = document.getElementById("checkpointDropdown");
	if (!event.target.matches('.checkpointbtn')) {
		if(divToHide.style.display === 'block'){
			divToHide.style.display = 'none';
		}
	}
}

/*************************
	Character
**************************/

/* When the user clicks on the button,
toggle between hiding and showing the dropdown content */
function characterTapped() {
	self.selectedButton = "character";
	var element = document.getElementById("characterDropdown");
	toggleDisplay(element);
}

window.onclick = function(event) {
	var divToHide = document.getElementById("characterDropdown");
	if (!event.target.matches('.characterbtn')) {
		if(divToHide.style.display === 'block'){
			divToHide.style.display = 'none';
		}
	}
}

/*************************
	Terrain
**************************/

/* When the user clicks on the button,
toggle between hiding and showing the dropdown content */
function terrainTapped() {
	self.selectedButton = "terrain";
	var element = document.getElementById("myTerrainDropdown");
	toggleDisplay(element);
}

// Close the Terrain dropdown if the user clicks outside of it
window.onclick = function(event) {
	var divToHide = document.getElementById("myTerrainDropdown");
	if (!event.target.matches('.terrainbtn')) {
		if(divToHide.style.display === 'block'){
			divToHide.style.display = 'none';
		}
	}
}

window.onclick = function(event) {
	var divToHide = document.getElementById("myWeaponDropdown");
	if (!event.target.matches('.weaponbtn')) {
		if(divToHide.style.display === 'block'){
			divToHide.style.display = 'none';
		}
	}
}

self.terrain1Tapped = function(){
    self.selectedTerrain = "3x2";
}

self.terrain2Tapped = function(){
    self.selectedTerrain = "3x2Breakable";
}

self.terrain3Tapped = function(){
    self.selectedTerrain = "3x4";
}

self.terrain4Tapped = function(){
    self.selectedTerrain = "3x4Breakable";
}

self.terrain5Tapped = function(){
    self.selectedTerrain = "3x6";
}

self.terrain6Tapped = function(){
    self.selectedTerrain = "3x6Breakable";
}


/* When the user clicks on the button,
toggle between hiding and showing the dropdown content */
function weaponTapped() {
	self.selectedButton = "weapon";
	var element = document.getElementById("myWeaponDropdown");
	toggleDisplay(element);
}

// Close the weapon dropdown if the user clicks outside of it
window.onclick = function(event) {
	var divToHide = document.getElementById("myWeaponDropdown");
	if (!event.target.matches('.weaponbtn')) {
		if(divToHide.style.display === 'block'){
			divToHide.style.display = 'none';
		}
	}
}

self.pistolTapped = function(){
	self.selectedWeapon = "pistol";
}

self.assaultTapped = function() {
	self.selectedWeapon = "assault";
}

self.shotgunTapped = function() {
	self.selectedWeapon = "shotgun";
}

self.swordTapped = function() {
	self.selectedWeapon = "sword";
}

var pos;
var id;
var x;
var y;

//Drawing a preview of the object to be placed on the level
//and snapping the top right corner of the preview to the grid lines
snapToGrid  = function(canvas,mouse){
	var pos = getMousePosition(canvas,mouse);
	var prev_x = pos.x - (pos.x % TILE_HEIGHT);
	var prev_y = pos.y - (pos.y % TILE_WIDTH);

	let entity = null;
	var tempID = 0;
	var previewImage = new Image();

	if(self.selectedButton === 'enemies'){
		switch(self.selectedEnemy){
			case "enemy1":
			case "enemy2":
			case "enemy3":
				entity = Enemy(tempID,self.selectedEnemy,prev_x,prev_y);
				break;
		}
		entity.draw(ctx_ep);
	}
	else if(self.selectedButton === "checkpoint"){
		previewImage.src = "../../images/placeCheckpoint.png";
		ctx_ep.drawImage(previewImage, prev_x, prev_y, TILE_WIDTH, TILE_HEIGHT);
	}
	else if(self.selectedButton === "music"){
		previewImage.src = "../../images/placeCheckpoint.png";
		ctx_ep.drawImage(previewImage, prev_x, prev_y, TILE_WIDTH, TILE_HEIGHT);
	}
	else if(self.selectedButton === "terrain"){
		switch(self.selectedTerrain){
			case "3x2":
				entity = Terrain3x2(tempID,prev_x,prev_y);
				break;
			case "3x2Breakable":
				entity = Terrain3x2Breakable(tempID,prev_x,prev_y);
				break;
			case "3x4":
				entity = Terrain3x4(tempID,prev_x,prev_y);
				break;
			case "3x4Breakable":
				entity = Terrain3x4Breakable(tempID,prev_x,prev_y);
				break;
			case "3x6":
				entity = Terrain3x6(tempID,prev_x,prev_y);
				break;
			case "3x6Breakable":
				entity = Terrain3x6Breakable(tempID,prev_x,prev_y);
				break;
		}
		entity.draw(ctx_ep);
    }
	else {
		ctx_ep.fillRect(x,y,TILE_WIDTH,TILE_HEIGHT);
  	}
};


document.onmousemove = function(mouse){
	pos = getMousePosition(bg,mouse);
	x = pos.x - (pos.x % TILE_HEIGHT) - offsetX;
	y = pos.y - (pos.y % TILE_WIDTH) - offsetY;

	var mouseBelowUpperBound = pos.x<WIDTH && pos.y<HEIGHT;
	var mouseAboveLowerBound = pos.x>0 && pos.y>TILE_HEIGHT*2;

	if(mouseBelowUpperBound && mouseAboveLowerBound){
		ctx_ep.clearRect(0,0,WIDTH,HEIGHT);
		snapToGrid(ep,mouse);
	}
};


getMousePosition = function(canvas,mouse){
	var rect = canvas.getBoundingClientRect();
	return {
		x: mouse.clientX - rect.left,
		y: mouse.clientY - rect.top,
	};
};


document.onmousedown = function(mouse){
	if(mouse.which ===1){
		mouseLeft = true;
	}
	else{
		mouseRight = true;
	}

	pos = getMousePosition(bg,mouse);
	x = pos.x - (pos.x % TILE_HEIGHT) - offsetX;
	y = pos.y - (pos.y % TILE_WIDTH) - offsetY;
};


putEntity = function(entity) {
	var mouseBelowUpperBound = pos.x<levelground.width && pos.y<levelground.height+(2*TILE_HEIGHT);
	var mouseAboveLowerBound = pos.x>0 && pos.y>TILE_HEIGHT*2;
	var entity;

	var id = Math.random();
	if(mouseBelowUpperBound && mouseAboveLowerBound){
		if(((x+rectWIDTH) <= WIDTH) && ((y+rectHEIGHT) <= HEIGHT)){
			if(self.selectedButton !== null){
				if(self.selectedButton === 'enemies'){
					if(self.selectedEnemy === 'enemy1'){
						entity = Enemy(id, 'enemy1', x, y, TILE_WIDTH, TILE_HEIGHT);
					} else if(self.selectedEnemy === "enemy2"){
						entity = Enemy(id, "enemy2", x, y, TILE_WIDTH, TILE_HEIGHT);
					} else if(self.selectedEnemy === "enemy3"){
						entity = Enemy(id, "enemy3", x, y, TILE_WIDTH, TILE_HEIGHT);
					} else {
						console.log("enemy error");
					}
				}else if(self.selectedButton === "terrain"){
              		if(self.selectedTerrain === "3x2"){
						entity = Terrain3x2(id, x, y);
					}else if(self.selectedTerrain === "3x2Breakable"){
						entity = Terrain3x2Breakable(id, x, y);
					}else if(self.selectedTerrain === "3x4"){
						entity = Terrain3x4(id, x, y);
					}else if(self.selectedTerrain === "3x4Breakable"){
						entity = Terrain3x4Breakable(id, x, y);
					}else if(self.selectedTerrain === "3x6"){
						entity = Terrain3x6(id, x, y);
              		}else if(self.selectedTerrain === "3x6Breakable"){
						entity = Terrain3x6Breakable(id, x, y);
					}else{
						console.log("terrain problem");
					}
				}
				map.tryToPlaceEntity(entity);
				// map.convertToString();
			}else{
				console.log("No entity selected");
			}
		}
		else{
			console.log("Can not place object there");
		}
	}
};


deleteEntity = function() {
	var mouseBelowUpperBound = pos.x<levelground.width && pos.y<levelground.height+(2*TILE_HEIGHT);
	var mouseAboveLowerBound = pos.x>0 && pos.y>TILE_HEIGHT*2;
	if(mouseBelowUpperBound && mouseAboveLowerBound){
		map.removeEntity(x,y);
	}
};

document.onmouseup = function(mouse){
	if(mouse.which ===1){
		mouseLeft = false;
	}
	else{
		mouseRight = false;
	}
};


//Supressing context menu on right click
document.oncontextmenu = function(mouse){
	mouse.preventDefault();
};


drawGrid = function(){
	ctx_gr.globalAlpha = 0.05;
	ctx_gr.lineWidth = 2;
	ctx_gr.strokeStyle = "#515151";

	//Drawing vertical lines
	for(x=TILE_WIDTH; x<=WIDTH*2; x+=TILE_WIDTH){
		ctx_gr.moveTo(x,TILE_HEIGHT*2);	//The first 2 rows of the canvas are used by buttons
		ctx_gr.lineTo(x,HEIGHT);
		ctx_gr.stroke();
	}

	//Drawing horizontal lines
	for(y=TILE_HEIGHT*2; y<=HEIGHT*2; y+=TILE_HEIGHT){
		ctx_gr.moveTo(0,y);
		ctx_gr.lineTo(WIDTH,y);
		ctx_gr.stroke();
	}

	ctx_gr.globalAlpha = 1;
};


self.drawBackground = function(){
	ctx_bg.clearRect(0,0,WIDTH,HEIGHT);
	if(self.selectedBackground === "world1"){
		ctx_bg.drawImage(worldOneBackgroundImage, 0, 0, worldOneBackgroundImage.width, worldOneBackgroundImage.height,offsetX,offsetY, WIDTH, HEIGHT);
	} else if(self.selectedBackground === "world2"){
		ctx_bg.drawImage(worldTwoBackgroundImage, 0, 0, worldTwoBackgroundImage.width, worldTwoBackgroundImage.height,offsetX,offsetY, WIDTH, HEIGHT);
	} else if(self.selectedBackground === "world3"){
		ctx_bg.drawImage(worldThreeBackgroundImage, 0, 0, worldThreeBackgroundImage.width, worldThreeBackgroundImage.height,offsetX,offsetY, WIDTH, HEIGHT);
	} else {
		ctx_bg.drawImage(backgroundImage, 0, 0,backgroundImage.width,backgroundImage.height,offsetX,offsetY, WIDTH, HEIGHT);
	}
};


update = function() {
	ctx_lg.clearRect(0,0,WIDTH,HEIGHT);
	map.update();
	doPressedAction();
};

// Calling update 60 times a second
setInterval(update, 1000/fps);

init = function() {
	drawGrid();
	drawBackground();
};

</script>
<head>

<link rel="stylesheet" type="text/css" href="LevelEditorStyling.css">
<!-- <script src="jquery-3.3.1.min.js"></script> -->

</head>
<body onload = "init()">
</body>
